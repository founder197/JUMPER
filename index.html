<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bridge dApp ‚Äì Powered by LI.FI</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="https://li.fi/favicon.ico" />
  <style>
    /* Estilo para tornar o bot√£o 'disabled' mais claro, caso o Tailwind padr√£o n√£o seja suficiente */
    #executeBridge:disabled,
    #getQuote:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }
    /* Estilo para setas em select */
    .select-arrow {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='white'%3e%3cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 1.5em 1.5em;
    }
  </style>
</head>
<body class="bg-slate-900 text-gray-100 min-h-screen flex flex-col items-center justify-center p-4">

  <div class="w-full max-w-md bg-slate-800/90 backdrop-blur-sm rounded-3xl shadow-2xl shadow-blue-500/10 p-8 border border-slate-700">
    
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-3xl font-extrabold text-blue-400 flex items-center">
        <span class="mr-2">üåâ</span> LI.FI Bridge
      </h1>
      <button id="connectWallet" class="px-4 py-2 text-sm font-semibold rounded-full bg-blue-600 hover:bg-blue-700 transition shadow-md shadow-blue-500/30">
        Conectar Carteira
      </button>
    </div>

    <div id="walletInfo" class="text-sm text-gray-400 mb-6 border-b border-slate-700 pb-4">
      <p class="animate-pulse">Aguardando conex√£o...</p>
    </div>

    <div class="space-y-5">
      
      <div class="input-group">
        <label for="fromChain" class="text-gray-300 text-sm font-medium block mb-1">De Chain</label>
        <select id="fromChain" class="w-full p-3 rounded-xl bg-slate-700 border border-slate-600 focus:ring-blue-500 focus:border-blue-500 appearance-none select-arrow">
            <option value="" disabled selected>Carregando redes...</option>
        </select>
        <span id="fromChainToken" class="text-xs text-gray-500 mt-1 block">Token fixo: USDC</span>
      </div>

      <div class="flex justify-center">
        <button id="swapChains" class="p-2 rounded-full bg-slate-700 hover:bg-slate-600 transition disabled:opacity-50" aria-label="Trocar redes de origem e destino">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 2a.75.75 0 01.75.75v10.5l3.22-3.22a.75.75 0 111.06 1.06l-4.5 4.5a.75.75 0 01-1.06 0l-4.5-4.5a.75.75 0 111.06-1.06l3.22 3.22V2.75A.75.75 0 0110 2z" clip-rule="evenodd" />
          </svg>
        </button>
      </div>

      <div class="input-group">
        <label for="toChain" class="text-gray-300 text-sm font-medium block mb-1">Para Chain</label>
        <select id="toChain" class="w-full p-3 rounded-xl bg-slate-700 border border-slate-600 focus:ring-blue-500 focus:border-blue-500 appearance-none select-arrow">
            <option value="" disabled selected>Carregando redes...</option>
        </select>
        <span id="toChainToken" class="text-xs text-gray-500 mt-1 block">Token fixo: USDC</span>
      </div>

      <div class="input-group">
        <label for="amount" class="text-gray-300 text-sm font-medium block mb-1">Valor (USDC)</label>
        <input id="amount" class="w-full p-3 rounded-xl bg-slate-700 border border-slate-600 placeholder-gray-500 focus:ring-blue-500 focus:border-blue-500" type="number" placeholder="Ex: 10.5" step="any" />
      </div>
    </div>

    <div class="flex justify-between mt-6">
      <button id="getQuote" class="flex-1 mr-2 px-4 py-3 rounded-xl font-bold bg-indigo-500 hover:bg-indigo-600 transition disabled:opacity-60 disabled:cursor-not-allowed" disabled>
        Obter Cota√ß√£o
      </button>
      <button id="executeBridge" class="flex-1 ml-2 px-4 py-3 rounded-xl font-bold bg-green-500 hover:bg-green-600 transition disabled:opacity-60 disabled:cursor-not-allowed" disabled>
        Executar Bridge
      </button>
    </div>

    <div class="mt-6">
      <p class="text-sm font-medium text-gray-400 mb-2">Logs de Execu√ß√£o:</p>
      <pre id="output" class="bg-slate-900/70 p-4 rounded-xl text-xs text-gray-300 whitespace-pre-wrap border border-slate-700 shadow-inner min-h-[6rem]">Aguardando a√ß√£o...</pre>
    </div>

    <div class="mt-6 text-center text-gray-500 text-xs">
      Powered by <a href="https://li.fi" target="_blank" class="text-blue-400 hover:text-blue-300 transition">LI.FI / Jumper</a>
    </div>
  </div>

  <script>
    // --- Mapeamento de Tokens Padr√£o (Fixamos no USDC para este exemplo) ---
    // Em um app de produ√ß√£o, voc√™ precisaria buscar o tokenAddress correto para CADA rede.
    // Para simplificar e manter o c√≥digo funcional, usaremos o USDC (6 decimais) de cada rede como exemplo.
    const COMMON_USDC_ADDRESSES = {
        '1': '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48', // ETH
        '10': '0x7F5c764cBc14f9669B88837ca1490cCa17c31607', // Optimism
        '56': '0x8AC76a51cc950d9822D68b83Ff17aA929237bA75', // BSC (Aten√ß√£o: Endere√ßo do BUSD/USDT/USDC pode variar, usei um comum)
        '137': '0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174', // Polygon
        '250': '0x04068DA6C83AFCfa0E13ba15A6696662335D5B73', // Fantom
        '42161': '0xaf88d065e77c8cC2239327C5EDb3A432268e5831', // Arbitrum
        '43114': '0xB97EF9e8739dE5B87aB47DE06eA0aA8f21708edc', // Avalanche
        '8453': '0x833589fCD6eDbE020b86f8433fBf6189c6BdD49f', // Base
        '59144': '0x539c39d89C6F5b7662D1C1B11c1d81E52119934B', // Linea
        // Adicione mais USDC conforme as Chain IDs da LI.FI
    };
    
    // Objeto que armazenar√° APENAS as chains Mainnet e seus dados
    let AVAILABLE_CHAINS = {};

    let provider, signer, userAddress, currentQuote;

    // Elementos da UI
    const outputEl = document.getElementById("output");
    const connectBtn = document.getElementById("connectWallet");
    const walletInfoEl = document.getElementById("walletInfo");
    const getQuoteBtn = document.getElementById("getQuote");
    const executeBridgeBtn = document.getElementById("executeBridge");
    const swapChainsBtn = document.getElementById("swapChains");
    const amountEl = document.getElementById("amount");
    const fromChainEl = document.getElementById("fromChain");
    const toChainEl = document.getElementById("toChain");

    // Fun√ß√£o de Logging (com cores e timestamp)
    const log = (msg, type = 'info') => {
        let color = 'text-gray-300';
        if (type === 'success') color = 'text-green-400';
        if (type === 'error') color = 'text-red-400';
        if (type === 'warn') color = 'text-yellow-400';
        if (type === 'process') color = 'text-blue-400';
        
        const timestamp = new Date().toLocaleTimeString('pt-BR');
        
        outputEl.innerHTML = `<span class="${color}">[${timestamp}] ${msg}</span>\n` + outputEl.innerHTML;
        const lines = outputEl.textContent.split('\n').filter(line => line.trim() !== '');
        outputEl.textContent = lines.slice(0, 10).join('\n'); 
    };

    // --- FUN√á√ÉO DE INICIALIZA√á√ÉO E CARREGAMENTO DE REDES ---
    const loadChains = async () => {
        log("üåé Buscando redes Mainnet dispon√≠veis...", 'process');
        fromChainEl.disabled = true;
        toChainEl.disabled = true;

        try {
            // Chamada direta √† API da LI.FI (Este endpoint n√£o precisa de proxy, pois √© p√∫blico)
            const res = await fetch("https://li.quest/v1/chains");
            const data = await res.json();

            if (!res.ok || !data.chains) {
                log(`‚ùå Falha ao carregar redes: ${data.message || 'Erro na API.'}`, 'error');
                return;
            }

            // Filtra e Mapeia APENAS as Mainnets EVM
            const mainnetEVMChains = data.chains
                .filter(chain => chain.mainnet && chain.chainType === 'EVM')
                .sort((a, b) => a.name.localeCompare(b.name)); // Ordena por nome

            // Cria o objeto de mapeamento final para uso no script
            AVAILABLE_CHAINS = mainnetEVMChains.reduce((acc, chain) => {
                acc[chain.id] = {
                    id: chain.id,
                    name: chain.name,
                    key: chain.key,
                    // Tentamos usar o USDC padr√£o, se n√£o tiver, o app n√£o funcionar√° para essa rede.
                    tokenAddress: COMMON_USDC_ADDRESSES[chain.id] || null, 
                    decimals: 6, // USDC tem 6 decimais
                };
                return acc;
            }, {});

            // 1. Preenche os dropdowns
            const optionsHtml = mainnetEVMChains.map(chain => 
                // Usamos o chain.id como o 'value'
                `<option value="${chain.id}">${chain.name} (${chain.id})</option>`
            ).join('');
            
            fromChainEl.innerHTML = optionsHtml;
            toChainEl.innerHTML = optionsHtml;

            // 2. Define Polygon e Arbitrum como padr√£o (selecionados)
            fromChainEl.value = '137'; // Polygon
            toChainEl.value = '42161'; // Arbitrum

            fromChainEl.disabled = false;
            toChainEl.disabled = false;
            
            log(`‚úÖ ${mainnetEVMChains.length} redes EVM Mainnet carregadas!`, 'success');

        } catch (error) {
            log(`‚ùå Erro cr√≠tico ao carregar redes: ${error.message}`, 'error');
            fromChainEl.innerHTML = `<option value="" disabled selected>Erro ao carregar redes</option>`;
            toChainEl.innerHTML = `<option value="" disabled selected>Erro ao carregar redes</option>`;
        }
    };

    // --- A√á√ÉO 1: CONECTAR CARTEIRA (Mantida) ---
    // ... [O c√≥digo da fun√ß√£o connectWallet permanece o mesmo] ...
    connectBtn.addEventListener("click", async () => {
      if (!window.ethereum) return alert("Nenhuma carteira encontrada. Por favor, instale uma extens√£o como a MetaMask.");
      
      connectBtn.textContent = "Conectando...";
      connectBtn.disabled = true;
      walletInfoEl.innerHTML = '<p class="animate-pulse text-blue-300">Solicitando permiss√£o...</p>';

      try {
        provider = new ethers.providers.Web3Provider(window.ethereum, "any");
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        const network = await provider.getNetwork();
        
        walletInfoEl.innerHTML = 
          `<p class="text-green-400">‚úÖ Conectado:</p>
           <p class="text-sm mt-1">${userAddress.slice(0, 6)}...${userAddress.slice(-4)}</p>
           <p class="text-xs text-gray-500">Rede: ${network.name} (${network.chainId})</p>`;
        
        connectBtn.textContent = "Conectado";
        connectBtn.classList.remove('bg-blue-600');
        connectBtn.classList.add('bg-green-600', 'hover:bg-green-700');
        
        getQuoteBtn.disabled = false;

      } catch (error) {
        log(`Erro ao conectar: ${error.message || error}`, 'error');
        walletInfoEl.innerHTML = '<p class="text-red-400">‚ùå Falha na conex√£o</p>';
        connectBtn.textContent = "Conectar Carteira";
        connectBtn.classList.remove('bg-green-600');
        connectBtn.classList.add('bg-blue-600');
      } finally {
        connectBtn.disabled = false;
      }
    });

    // --- A√á√ÉO 2: OBTER COTA√á√ÉO (L√≥gica din√¢mica ajustada) ---
    getQuoteBtn.addEventListener("click", async () => {
      const amount = amountEl.value;
      if (!amount || isNaN(amount) || Number(amount) <= 0) return log("Insira um valor de USDC v√°lido.", 'warn');
      if (!userAddress) return log("Conecte a carteira primeiro.", 'warn');
      
      currentQuote = null;
      executeBridgeBtn.disabled = true;
      executeBridgeBtn.textContent = 'Executar Bridge';

      try {
        getQuoteBtn.textContent = "Buscando...";
        getQuoteBtn.disabled = true;
        log("üîç Buscando a melhor rota de bridge...", 'process');

        const fromChainId = fromChainEl.value; 
        const toChainId = toChainEl.value;
        
        if (fromChainId === toChainId) {
             throw new Error("N√£o √© poss√≠vel fazer bridge para a mesma rede.");
        }

        const fromChain = AVAILABLE_CHAINS[fromChainId];
        const toChain = AVAILABLE_CHAINS[toChainId];
        
        if (!fromChain || !toChain) {
             throw new Error("Chain ID inv√°lido ou n√£o carregado. Recarregue a p√°gina.");
        }
        
        if (!fromChain.tokenAddress || !toChain.tokenAddress) {
             throw new Error(`Token (USDC) n√£o mapeado para ${fromChain.name} ou ${toChain.name}.`);
        }

        const fromToken = fromChain.tokenAddress;
        const toToken = toChain.tokenAddress;
        
        const fromAmountBN = ethers.utils.parseUnits(amount, fromChain.decimals);
        const fromAmount = fromAmountBN.toString(); 

        // URL para o seu Serverless Function (proxy)
        const url = `/api/quote?fromChain=${fromChainId}&toChain=${toChainId}&fromToken=${fromToken}&toToken=${toToken}&fromAddress=${userAddress}&toAddress=${userAddress}&fromAmount=${fromAmount}`;

        const res = await fetch(url);
        const data = await res.json();

        if (!res.ok || !data?.estimate) {
            log(`‚ùå Nenhuma rota v√°lida encontrada ou erro na API.`, 'error');
            log(`Detalhes do Erro: ${data.message || 'Sem dados de erro.'}`, 'error');
            return;
        }

        currentQuote = data;
        const est = data.estimate;
        
        const toAmount = ethers.utils.formatUnits(est.toAmount, toChain.decimals);
        const time = est.executionDuration || "N/A";

        log(`‚úÖ Rota encontrada!`, 'success');
        log(`Bridge: ${est.tool}\nDe: ${amount} USDC (${fromChain.name})\nPara: ${Number(toAmount).toFixed(4)} USDC (${toChain.name})\nTempo Estimado: ${time}s`);
        
        executeBridgeBtn.disabled = false;
        executeBridgeBtn.textContent = `Executar via ${est.tool}`;

      } catch (error) {
        log(`‚ùå Erro ao buscar cota√ß√£o: ${error.message}`, 'error');
      } finally {
        getQuoteBtn.textContent = "Obter Cota√ß√£o";
        getQuoteBtn.disabled = false;
      }
    });

    // --- A√á√ÉO 3: EXECUTAR BRIDGE (Mantida) ---
    executeBridgeBtn.addEventListener("click", async () => {
      if (!currentQuote) return log("Nenhuma cota√ß√£o para executar!", 'warn');
      
      executeBridgeBtn.textContent = "Preparando...";
      executeBridgeBtn.disabled = true;
      getQuoteBtn.disabled = true;

      try {
        log("‚öôÔ∏è Preparando transa√ß√£o (chamando backend)...", 'process');
        
        const res = await fetch("/api/transaction", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(currentQuote)
        });
        const txData = await res.json();
        
        if (!res.ok || !txData.transactionRequest) {
          log("‚ùå Falha ao obter dados da transa√ß√£o do backend.", 'error');
          log(`Detalhes do Erro: ${txData.message || 'Verifique os logs do Vercel.'}`, 'error');
          throw new Error("Invalid transaction data from API.");
        }

        const tx = txData.transactionRequest;
        
        log(`üì§ Solicitando confirma√ß√£o na carteira...`, 'process');
        
        const txResponse = await signer.sendTransaction({
          to: tx.to,
          data: tx.data,
          value: tx.value ? ethers.BigNumber.from(tx.value) : 0
        });

        log(`‚è≥ Transa√ß√£o enviada!`, 'process');
        log(`Hash: ${txResponse.hash}\nAguardando confirma√ß√£o na blockchain...`);
        
        await txResponse.wait();
        
        log(`üéâ Bridge conclu√≠da com sucesso!`, 'success');
        log(`Hash Final: ${txResponse.hash}`);
        
      } catch (error) {
        const msg = error.code === 4001 ? 'Transa√ß√£o rejeitada pelo usu√°rio.' : error.message || 'Erro desconhecido durante a transa√ß√£o.';
        log(`‚ùå Erro de Transa√ß√£o: ${msg}`, 'error');
      } finally {
        executeBridgeBtn.textContent = "Executar Bridge";
        executeBridgeBtn.disabled = true; 
        getQuoteBtn.disabled = false;
      }
    });

    // --- L√ìGICA DO SWAP DE REDES ---
    swapChainsBtn.addEventListener('click', () => {
        const fromChain = fromChainEl.value;
        const toChain = toChainEl.value;

        // Troca os valores dos selects
        fromChainEl.value = toChain;
        toChainEl.value = fromChain;

        // Desabilita execu√ß√£o e limpa quote
        executeBridgeBtn.disabled = true;
        executeBridgeBtn.textContent = 'Executar Bridge';

        log("üîÑ Redes trocadas! Busque uma nova cota√ß√£o.", 'info');
    });

    // --- Inicializa√ß√£o ---
    loadChains(); 
  </script>
</body>
</html>
