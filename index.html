<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bridge dApp ‚Äì Powered by LI.FI (USDT)</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="https://li.fi/favicon.ico" />
  <style>
    #executeBridge:disabled,
    #getQuote:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }
    .select-arrow {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='white'%3e%3cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      background-size: 1.5em 1.5em;
    }
  </style>
</head>
<body class="bg-slate-900 text-gray-100 min-h-screen flex flex-col items-center justify-center p-4">

  <div class="w-full max-w-md bg-slate-800/90 backdrop-blur-sm rounded-3xl shadow-2xl shadow-blue-500/10 p-8 border border-slate-700">
    
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-3xl font-extrabold text-blue-400 flex items-center">
        <span class="mr-2">üåâ</span> USDT LI.FI Bridge
      </h1>
      <button id="connectWallet" class="px-4 py-2 text-sm font-semibold rounded-full bg-blue-600 hover:bg-blue-700 transition shadow-md shadow-blue-500/30">
        Conectar Carteira
      </button>
    </div>

    <div id="walletInfo" class="text-sm text-gray-400 mb-6 border-b border-slate-700 pb-4">
      <p class="animate-pulse">Aguardando conex√£o...</p>
    </div>

    <div class="space-y-5">
      
      <div class="input-group">
        <label for="fromChain" class="text-gray-300 text-sm font-medium block mb-1">De Chain</label>
        <select id="fromChain" class="w-full p-3 rounded-xl bg-slate-700 border border-slate-600 focus:ring-blue-500 focus:border-blue-500 appearance-none select-arrow">
            <option value="" disabled selected>Carregando redes...</option>
        </select>
        <div class="flex justify-between items-center mt-1">
          <span id="fromChainToken" class="text-xs text-gray-500">Token: USDT</span>
          <span id="fromChainBalance" class="text-xs text-blue-300 font-medium">Saldo: --</span>
        </div>
      </div>

      <div class="flex justify-center">
        <button id="swapChains" class="p-2 rounded-full bg-slate-700 hover:bg-slate-600 transition disabled:opacity-50" aria-label="Trocar redes de origem e destino" disabled>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 2a.75.75 0 01.75.75v10.5l3.22-3.22a.75.75 0 111.06 1.06l-4.5 4.5a.75.75 0 01-1.06 0l-4-4a.75.75 0 111.06-1.06l3.22 3.22V2.75A.75.75 0 0110 2z" clip-rule="evenodd" />
          </svg>
        </button>
      </div>

      <div class="input-group">
        <label for="toChain" class="text-gray-300 text-sm font-medium block mb-1">Para Chain</label>
        <select id="toChain" class="w-full p-3 rounded-xl bg-slate-700 border border-slate-600 focus:ring-blue-500 focus:border-blue-500 appearance-none select-arrow">
            <option value="" disabled selected>Carregando redes...</option>
        </select>
        <span id="toChainToken" class="text-xs text-gray-500 mt-1 block">Token: USDT</span>
      </div>

      <div class="input-group">
        <label for="amount" class="text-gray-300 text-sm font-medium block mb-1">Valor (USDT)</label>
        <input id="amount" class="w-full p-3 rounded-xl bg-slate-700 border border-slate-600 placeholder-gray-500 focus:ring-blue-500 focus:border-blue-500" type="number" placeholder="Ex: 10.5" step="any" />
      </div>
    </div>

    <div class="flex justify-between mt-6">
      <button id="getQuote" class="flex-1 mr-2 px-4 py-3 rounded-xl font-bold bg-indigo-500 hover:bg-indigo-600 transition disabled:opacity-60 disabled:cursor-not-allowed" disabled>
        Obter Cota√ß√£o
      </button>
      <button id="executeBridge" class="flex-1 ml-2 px-4 py-3 rounded-xl font-bold bg-green-500 hover:bg-green-600 transition disabled:opacity-60 disabled:cursor-not-allowed" disabled>
        Executar Bridge
      </button>
    </div>

    <div class="mt-6">
      <p class="text-sm font-medium text-gray-400 mb-2">Logs de Execu√ß√£o:</p>
      <pre id="output" class="bg-slate-900/70 p-4 rounded-xl text-xs text-gray-300 whitespace-pre-wrap border border-slate-700 shadow-inner min-h-[6rem]">Aguardando a√ß√£o...</pre>
    </div>

    <div class="mt-6 text-center text-gray-500 text-xs">
      Powered by <a href="https://li.fi" target="_blank" class="text-blue-400 hover:text-blue-300 transition">LI.FI / Jumper</a>
    </div>
  </div>

  <script>
    // --- Mapeamento de Tokens Padr√£o (Foco no USDT) ---
    // Corrigido: Removido o endere√ßo problem√°tico da Base (8453)
    const COMMON_USDT_ADDRESSES = {
        '1': '0xdAC17F958D2ee523a2206206994597C13D831ec7', // Ethereum (1) - 6 Decimais
        '10': '0x94b008aA29c5124dD070aE447a029fcd6436bB71', // Optimism (10) - 6 Decimais
        '56': '0x55d398326f99059fF775485246999027B3197955', // BNB Chain (56) - 18 Decimais
        '137': '0xc2132D05D31c914a87C6611C10748AEb04B58e8F', // Polygon (137) - 6 Decimais
        '250': '0x049d68029688EAbF473097a2fE32A8c4479fEdf3', // Fantom (250) - 6 Decimais
        '42161': '0xFd086bc7A59EFe830F1f0c2fA166c17E7d0dC051', // Arbitrum (42161) - 6 Decimais
        '43114': '0x9702230A8Ea53601f5cd2dc00fDBc13d632aC4CD', // Avalanche (43114) - 6 Decimais
        // '8453': '...', // Base (8453) - Endere√ßo estava com erro, removido temporariamente
        '59144': '0xFd086bc7A59EFe830F1f0c2fA166c17E7d0dC051', // Linea (59144) - 6 Decimais
    };
    
    // Objeto que armazenar√° as chains Mainnet e seus dados
    let AVAILABLE_CHAINS = {};

    let provider, signer, userAddress, currentQuote;
    // ABI M√≠nimo do ERC20 para buscar saldo
    const ERC20_ABI = ["function balanceOf(address) view returns (uint256)"];

    // Elementos da UI
    const outputEl = document.getElementById("output");
    const connectBtn = document.getElementById("connectWallet");
    const walletInfoEl = document.getElementById("walletInfo");
    const getQuoteBtn = document.getElementById("getQuote");
    const executeBridgeBtn = document.getElementById("executeBridge");
    const swapChainsBtn = document.getElementById("swapChains");
    const amountEl = document.getElementById("amount");
    const fromChainEl = document.getElementById("fromChain");
    const toChainEl = document.getElementById("toChain");
    const fromBalanceEl = document.getElementById("fromChainBalance");
    const fromTokenInfoEl = document.getElementById("fromChainToken");

    // Fun√ß√£o de Logging (com cores e timestamp)
    const log = (msg, type = 'info') => {
        let color = 'text-gray-300';
        if (type === 'success') color = 'text-green-400';
        if (type === 'error') color = 'text-red-400';
        if (type === 'warn') color = 'text-yellow-400';
        if (type === 'process') color = 'text-blue-400';
        
        const timestamp = new Date().toLocaleTimeString('pt-BR');
        
        outputEl.innerHTML = `<span class="${color}">[${timestamp}] ${msg}</span>\n` + outputEl.innerHTML;
        const lines = outputEl.textContent.split('\n').filter(line => line.trim() !== '');
        outputEl.textContent = lines.slice(0, 10).join('\n'); 
    };
    
    // --- **NOVO: FUN√á√ÉO PARA BUSCAR SALDO** ---
    const fetchBalance = async (selectedChainId) => {
        if (!provider || !userAddress || !selectedChainId || !AVAILABLE_CHAINS[selectedChainId]) {
            fromBalanceEl.textContent = "Saldo: --";
            return;
        }
        
        const chain = AVAILABLE_CHAINS[selectedChainId];
        const tokenAddress = chain.tokenAddress;
        const decimals = chain.decimals;

        if (!tokenAddress) {
            fromBalanceEl.textContent = "Saldo: N/A"; // Token n√£o mapeado
            return;
        }

        try {
            const network = await provider.getNetwork();
            const connectedChainId = network.chainId.toString();

            // S√≥ busca o saldo se a carteira estiver na rede selecionada
            if (connectedChainId !== selectedChainId) {
                fromBalanceEl.textContent = "Saldo: Mude a rede para ver";
                return;
            }

            fromBalanceEl.textContent = "Saldo: Carregando...";
            
            const contract = new ethers.Contract(tokenAddress, ERC20_ABI, provider);
            const balanceBN = await contract.balanceOf(userAddress);
            
            const formattedBalance = ethers.utils.formatUnits(balanceBN, decimals);
            
            // Arredonda para 4 casas decimais para exibi√ß√£o
            fromBalanceEl.textContent = `Saldo: ${parseFloat(formattedBalance).toFixed(4)}`;

        } catch (error) {
            console.error("Fetch Balance Error:", error);
            fromBalanceEl.textContent = "Saldo: Erro";
        }
    };


    // --- FUN√á√ÉO DE INICIALIZA√á√ÉO E CARREGAMENTO DE REDES ---
    const loadChains = async () => {
        log("üåé Buscando redes Mainnet dispon√≠veis...", 'process');
        fromChainEl.disabled = true;
        toChainEl.disabled = true;

        try {
            const res = await fetch("https://li.quest/v1/chains");
            const data = await res.json();

            if (!res.ok || !data.chains) {
                log(`‚ùå Falha ao carregar redes: ${data.message || 'Erro na API.'}`, 'error');
                return;
            }

            const mainnetEVMChains = data.chains
                .filter(chain => chain.mainnet && chain.chainType === 'EVM')
                .sort((a, b) => a.name.localeCompare(b.name)); 

            AVAILABLE_CHAINS = mainnetEVMChains.reduce((acc, chain) => {
                const tokenDecimals = chain.id === 56 ? 18 : 6; // BNB Chain USDT √© 18, a maioria √© 6
                
                acc[chain.id] = {
                    id: chain.id,
                    name: chain.name,
                    key: chain.key,
                    tokenAddress: COMMON_USDT_ADDRESSES[chain.id] || null, 
                    decimals: tokenDecimals, 
                };
                return acc;
            }, {});

            // Preenche os dropdowns
            const optionsHtml = mainnetEVMChains.map(chain => {
                const isSupported = AVAILABLE_CHAINS[chain.id].tokenAddress; // Verifica se o token est√° mapeado
                const displayName = isSupported ? chain.name : `${chain.name} (USDT n√£o mapeado)`;
                return `<option value="${chain.id}" ${isSupported ? '' : 'disabled'}>${displayName} (${chain.id})</option>`;
            }).join('');
            
            fromChainEl.innerHTML = optionsHtml;
            toChainEl.innerHTML = optionsHtml;

            // Define Arbitrum como padr√£o de origem e Polygon como destino
            fromChainEl.value = '42161'; // Arbitrum (Onde voc√™ disse que tem USDT)
            toChainEl.value = '137'; // Polygon 

            fromChainEl.disabled = false;
            toChainEl.disabled = false;
            swapChainsBtn.disabled = false;
            
            // Atualiza info de decimais do token padr√£o (Arbitrum)
            fromTokenInfoEl.textContent = `Token: USDT (${AVAILABLE_CHAINS['42161'].decimals} decimais)`;
            
            log(`‚úÖ ${mainnetEVMChains.length} redes EVM Mainnet carregadas! (Foco em USDT)`, 'success');

        } catch (error) {
            log(`‚ùå Erro cr√≠tico ao carregar redes: ${error.message}`, 'error');
            fromChainEl.innerHTML = `<option value="" disabled selected>Erro ao carregar redes</option>`;
            toChainEl.innerHTML = `<option value="" disabled selected>Erro ao carregar redes</option>`;
        }
    };

    // --- A√á√ÉO 1: CONECTAR CARTEIRA (Gatilho de Saldo Adicionado) ---
    connectBtn.addEventListener("click", async () => {
      if (!window.ethereum) return log("Nenhuma carteira encontrada. Por favor, instale uma extens√£o como a MetaMask.", 'error');
      
      connectBtn.textContent = "Conectando...";
      connectBtn.disabled = true;
      walletInfoEl.innerHTML = '<p class="animate-pulse text-blue-300">Solicitando permiss√£o...</p>';

      try {
        provider = new ethers.providers.Web3Provider(window.ethereum, "any");
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        const network = await provider.getNetwork();
        
        walletInfoEl.innerHTML = 
          `<p class="text-green-400">‚úÖ Conectado:</p>
           <p class="text-sm mt-1">${userAddress.slice(0, 6)}...${userAddress.slice(-4)}</p>
           <p class="text-xs text-gray-500">Rede: ${network.name} (${network.chainId})</p>`;
        
        connectBtn.textContent = "Conectado";
        connectBtn.classList.remove('bg-blue-600');
        connectBtn.classList.add('bg-green-600', 'hover:bg-green-700');
        
        getQuoteBtn.disabled = false;
        
        // **NOVO: Buscar saldo ap√≥s conectar**
        fetchBalance(fromChainEl.value); 

      } catch (error) {
        log(`Erro ao conectar: ${error.code === 4001 ? 'Usu√°rio rejeitou a conex√£o.' : error.message || error}`, 'error');
        walletInfoEl.innerHTML = '<p class="text-red-400">‚ùå Falha na conex√£o</p>';
        connectBtn.textContent = "Conectar Carteira";
        connectBtn.classList.remove('bg-green-600');
        connectBtn.classList.add('bg-blue-600');
      } finally {
        connectBtn.disabled = false;
      }
    });
    
    // --- NOVO: Listener de mudan√ßa na "From Chain" ---
    fromChainEl.addEventListener('change', (e) => {
        const chainId = e.target.value;
        const chain = AVAILABLE_CHAINS[chainId];
        
        if (chain) {
            // Atualiza o texto de decimais
            fromTokenInfoEl.textContent = `Token: USDT (${chain.decimals} decimais)`;
            // Tenta buscar o saldo da nova rede selecionada
            fetchBalance(chainId);
        }
    });

    // --- NOVO: Listeners de eventos da Carteira (MetaMask) ---
    if (window.ethereum) {
        // Quando o usu√°rio troca de rede na MetaMask
        window.ethereum.on('chainChanged', (_chainId) => {
            log('Rede da carteira alterada.', 'info');
            // Recria o provider para a nova rede
            provider = new ethers.providers.Web3Provider(window.ethereum, "any");
            // Verifica o saldo da rede "From" selecionada (pode agora corresponder)
            fetchBalance(fromChainEl.value);
        });
        
        // Quando o usu√°rio troca de conta na MetaMask
        window.ethereum.on('accountsChanged', (accounts) => {
            if (accounts.length === 0) {
                log('Carteira desconectada.', 'warn');
                // Simplesmente recarrega a p√°gina para resetar o estado
                window.location.reload();
            } else {
                log('Conta da carteira alterada.', 'info');
                // Recarrega para for√ßar a reconex√£o e atualiza√ß√£o de saldos
                window.location.reload();
            }
        });
    }


    // --- A√á√ÉO 2: OBTER COTA√á√ÉO (L√≥gica USDT ajustada) ---
    getQuoteBtn.addEventListener("click", async () => {
      // ... (Restante do c√≥digo de getQuote) ...
      const amount = amountEl.value;
      if (!amount || isNaN(amount) || Number(amount) <= 0) return log("Insira um valor de USDT v√°lido.", 'warn');
      if (!userAddress) return log("Conecte a carteira primeiro.", 'warn');
      
      currentQuote = null;
      executeBridgeBtn.disabled = true;
      executeBridgeBtn.textContent = 'Executar Bridge';

      try {
        getQuoteBtn.textContent = "Buscando...";
        getQuoteBtn.disabled = true;
        log("üîç Buscando a melhor rota de bridge (USDT)...", 'process');

        const fromChainId = fromChainEl.value; 
        const toChainId = toChainEl.value;
        
        if (fromChainId === toChainId) {
             throw new Error("N√£o √© poss√≠vel fazer bridge para a mesma rede.");
        }

        const fromChain = AVAILABLE_CHAINS[fromChainId];
        const toChain = AVAILABLE_CHAINS[toChainId];
        
        if (!fromChain || !toChain) {
             throw new Error("Chain ID inv√°lido ou n√£o carregado. Recarregue a p√°gina.");
        }
        
        if (!fromChain.tokenAddress || !toChain.tokenAddress) {
             throw new Error(`Token (USDT) n√£o mapeado ou n√£o suportado para ${fromChain.name} ou ${toChain.name}.`);
        }

        const fromToken = fromChain.tokenAddress;
        const toToken = toChain.tokenAddress;
        
        const fromAmountBN = ethers.utils.parseUnits(amount, fromChain.decimals);
        const fromAmount = fromAmountBN.toString(); 

        const url = `/api/quote?fromChain=${fromChainId}&toChain=${toChainId}&fromToken=${fromToken}&toToken=${toToken}&fromAddress=${userAddress}&toAddress=${userAddress}&fromAmount=${fromAmount}`;

        const res = await fetch(url);
        const data = await res.json();

        if (!res.ok || !data?.estimate) {
            log(`‚ùå Nenhuma rota v√°lida encontrada ou erro na API.`, 'error');
            log(`Detalhes do Erro: ${data.message || 'Sem dados de erro.'}`, 'error');
            return;
        }

        currentQuote = data;
        const est = data.estimate;
        
        const toAmount = ethers.utils.formatUnits(est.toAmount, toChain.decimals);
        const time = est.executionDuration || "N/A";

        log(`‚úÖ Rota encontrada!`, 'success');
        log(`Bridge: ${est.tool}\nDe: ${amount} USDT (${fromChain.name})\nPara: ${Number(toAmount).toFixed(4)} USDT (${toChain.name})\nTempo Estimado: ${time}s`);
        
        executeBridgeBtn.disabled = false;
        executeBridgeBtn.textContent = `Executar via ${est.tool}`;

      } catch (error) {
        log(`‚ùå Erro ao buscar cota√ß√£o: ${error.message}`, 'error');
      } finally {
        getQuoteBtn.textContent = "Obter Cota√ß√£o";
        getQuoteBtn.disabled = false;
      }
    });

    // --- A√á√ÉO 3: EXECUTAR BRIDGE (Com verifica√ß√£o de rede) ---
    executeBridgeBtn.addEventListener("click", async () => {
      // ... (Restante do c√≥digo de executeBridge) ...
      if (!currentQuote) return log("Nenhuma cota√ß√£o para executar!", 'warn');
      
      executeBridgeBtn.textContent = "Preparando...";
      executeBridgeBtn.disabled = true;
      getQuoteBtn.disabled = true;

      try {
        log("‚öôÔ∏è Preparando transa√ß√£o (chamando backend)...", 'process');
        
        const res = await fetch("/api/transaction", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(currentQuote)
        });
        const txData = await res.json();
        
        if (!res.ok || !txData.transactionRequest) {
          log("‚ùå Falha ao obter dados da transa√ß√£o do backend.", 'error');
          log(`Detalhes do Erro: ${txData.message || 'Verifique os logs do Vercel.'}`, 'error');
          throw new Error("Invalid transaction data from API.");
        }

        const tx = txData.transactionRequest;
        
        // Verifica se a carteira est√° na rede correta antes de enviar
        const currentNetwork = await provider.getNetwork();
        const requiredChainId = parseInt(fromChainEl.value);

        if (currentNetwork.chainId !== requiredChainId) {
            log(`‚ö†Ô∏è Por favor, mude sua carteira para a rede de origem: ${AVAILABLE_CHAINS[requiredChainId].name} (${requiredChainId})`, 'warn');
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: `0x${requiredChainId.toString(16)}` }],
                });
                log("Aguardando troca de rede na carteira...", 'process');
                // Retorna para que o usu√°rio clique novamente ap√≥s a troca
                executeBridgeBtn.disabled = false;
                executeBridgeBtn.textContent = "Executar Bridge";
                getQuoteBtn.disabled = false;
                return; 
            } catch (switchError) {
                log("‚ùå N√£o foi poss√≠vel trocar a rede automaticamente. Por favor, fa√ßa manualmente.", 'error');
                throw new Error("Troca de rede necess√°ria.");
            }
        }
        
        log(`üì§ Solicitando confirma√ß√£o na carteira...`, 'process');
        
        const txResponse = await signer.sendTransaction({
          to: tx.to,
          data: tx.data,
          value: tx.value ? ethers.BigNumber.from(tx.value) : 0
        });

        log(`‚è≥ Transa√ß√£o enviada!`, 'process');
        log(`Hash: ${txResponse.hash}\nAguardando confirma√ß√£o na blockchain...`);
        
        await txResponse.wait();
        
        log(`üéâ Bridge conclu√≠da com sucesso!`, 'success');
        log(`Hash Final: ${txResponse.hash}`);
        
        // **NOVO: Atualizar saldo ap√≥s a transa√ß√£o**
        fetchBalance(fromChainEl.value); 
        
      } catch (error) {
        const msg = error.code === 4001 ? 'Transa√ß√£o rejeitada pelo usu√°rio.' : error.message || 'Erro desconhecido durante a transa√ß√£o.';
        log(`‚ùå Erro de Transa√ß√£o: ${msg}`, 'error');
      } finally {
        executeBridgeBtn.textContent = "Executar Bridge";
        executeBridgeBtn.disabled = true; 
        getQuoteBtn.disabled = false;
      }
    });

    // --- L√ìGICA DO SWAP DE REDES ---
    swapChainsBtn.addEventListener('click', () => {
        // ... (Restante do c√≥digo de swapChains) ...
        const fromChain = fromChainEl.value;
        const toChain = toChainEl.value;

        fromChainEl.value = toChain;
        toChainEl.value = fromChain;

        executeBridgeBtn.disabled = true;
        executeBridgeBtn.textContent = 'Executar Bridge';

        // **NOVO: Atualizar UI de saldo e decimais ao trocar**
        const newFromChain = AVAILABLE_CHAINS[toChain];
        if (newFromChain) {
            fromTokenInfoEl.textContent = `Token: USDT (${newFromChain.decimals} decimais)`;
            fetchBalance(newFromChain.id);
        }

        log("üîÑ Redes trocadas! Busque uma nova cota√ß√£o.", 'info');
    });

    // --- Inicializa√ß√£o ---
    loadChains(); 
  </script>
</body>
</html>
